<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./dist/output.css" />
    <link rel="stylesheet" href="css/trash-anime.css" />

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@100;300;400;500;600;700;800;900&family=Poppins:wght@100;300;400;500;600;700;800;900&family=Roboto:wght@100;300;400;500;700;900&display=swap"
      rel="stylesheet"
    />

    <!-- Leaflet CSS & JS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <title>TrashTalk</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/overLevel.js"></script>
    <script src="js/mapHandler.js"></script>
    <script src="js/mapAll.js"></script>
    <script src="js/waktuNav.js"></script>
    <script src="js/daftarkan.js"></script>

    <!-- <script src="js/mapAll.js"></script> -->
  </head>
  <body class="min-h-screen">
    <nav>
      <!-- Navbar atas -->
      <div class="flex justify-between items-center pr-2 pl-2">
        <div
          class="flex justify-center items-center xl:items-start xl:justify-start xl:ml-5 xl:mt-3 mt-8 gap-1"
        >
          <div class="relative w-8 h-8 -mt-5 xl:mt-2 lg:mt-2">
            <img
              src="assets/sampah.png"
              alt="logo kecil"
              class="w-full h-full object-contain"
            />
            <img
              src="assets/riak.png"
              alt="ikon tambahan"
              class="absolute inset-0 m-auto -translate-x-[0.5px] translate-y-1 xl:w-5 xl:h-5 xl:mr-[5.5px] object-contain"
            />
          </div>

          <h1
            class="font-poppins font-bold text-2xl xl:text-4xl text-black -mt-5 xl:mt-2 lg:mt-2"
          >
            Trash Talk
          </h1>
        </div>

        <a
          href="guide.html"
          class="relative z-50 mt-2 w-10 h-10 rounded-full border border-slate-700 flex justify-center items-center hover:bg-slate-200 transition"
        >
          <img src="assets/i.png" class="w-6 h-6 object-contain" />
        </a>
      </div>

      <div class="relative w-full overflow-hidden z-0 -mt-24 xl:-mt-32">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 512 84"
          preserveAspectRatio="none"
          class="w-full h-56 block"
        >
          <defs>
            <linearGradient id="greenGradient" x1="0" y1="0" x2="0" y2="1">
              <stop offset="20%" stop-color="#87db6b" />
              <stop offset="100%" stop-color="#179c46" />
            </linearGradient>
          </defs>
          <path
            fill="url(#greenGradient)"
            d="M0,50 C90,75 100,30 200,48 C350,70 420,30 512,55 L512,84 L0,84 Z"
          />
        </svg>
        <!-- Waktu Terakhir Update -->
        <div
          id="updateTimeContainer"
          class="xl:w-56 xl:h-9 xl:-mt-1 absolute left-1/2 -translate-x-1/2 top-[165px] bg-white rounded-xl shadow-[0_4px_12px_rgba(0,0,0,0.1)] hover:shadow-[0_6px_16px_rgba(0,0,0,0.15)] transition-shadow duration-300 p-1 w-40 text-center z-20 cursor-pointer group"
        >
          <h2
            id="updateTime"
            class="font-digital xl:font-medium mt-1 tracking-tighter font-medium text-xs xl:text-sm text-gray-800 group-hover:text-emerald-600 transition-colors duration-200"
          >
            Memuat waktu...
          </h2>
        </div>
      </div>
    </nav>

    <main
      class="relative z-20 w-full p-4 rounded-2xl bg-gradient-to-b from-[#87db6b] to-[#006134] flex flex-col -mt-3 shadow-lg"
    >
      <!-- dimatikan, item daftar -->
      <!-- <div
        id="modalDaftarkan"
        class="hidden fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 flex items-center justify-center"
      >
        <div
          class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md mx-4 transform transition-all duration-300 scale-95 opacity-0"
          id="modalContent"
        >
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-gray-800">
              Daftarkan Tong Sampah
            </h3>
            <button
              id="btnCloseModal"
              class="text-gray-500 hover:text-gray-700 transition-colors"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                ></path>
              </svg>
            </button>
          </div>

          <form id="formDaftarTong" class="space-y-4">
            <div>
              <label
                for="namaTong"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Nama Tong Sampah</label
              >
              <input
                type="text"
                id="namaTong"
                name="namaTong"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors"
                placeholder="Masukkan nama tong sampah"
                required
              />
            </div>

            <div>
              <label
                for="kodeTong"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Kode Tong</label
              >
              <input
                type="text"
                id="kodeTong"
                name="kodeTong"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors"
                placeholder="Masukkan kode tong"
                required
              />
            </div>

            <div class="flex justify-end gap-3 mt-6">
              <button
                type="button"
                id="btnBatalModal"
                class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors"
              >
                Batal
              </button>
              <button
                type="submit"
                class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors"
              >
                Daftarkan
              </button>
            </div>
          </form>
        </div>
      </div> -->

      <!-- Kontainer Tong sampah -->
      <div
        class="flex flex-wrap justify-center gap-5 xl:gap-20 xl:mt-5 mb-5 max-w-screen-lg xl:max-w-screen-xl mx-auto lg:gap-10"
      >
        <div
          class="relative flex flex-col items-center w-36 h-52 lg:w-64 lg:h-72 xl:w-72 xl:h-80 bg-white rounded-xl shadow-[4px_4px_10px_rgba(0,0,0,0.30)] transition-all duration-300 hover:scale-[1.03]"
        >
          <h4
            class="text-center text-[#006134] mt-2 font-poppins text-sm lg:text-lg xl:text-xl font-semibold"
          >
            Kayangan
          </h4>
          <div
            class="w-32 lg:w-56 xl:w-64 rounded-lg mx-auto mt-2 p-2 shadow-[4px_4px_10px_rgba(0,0,0,0.20)] transition-shadow duration-300 hover:shadow-[0_0_15px_3px_rgba(135,219,107,0.9)]"
          >
            <div class="relative trash-visual h-20 lg:h-36 xl:h-44">
              <img
                src="assets/sampahp.png"
                alt="Trash Icon"
                class="h-full w-auto mx-auto block object-contain relative z-10"
              />
              <div
                class="w-10 lg:w-16 xl:w-20 absolute bottom-0 left-0 right-0 trash-overlay rounded-b-lg mx-auto"
                style="height: -10%; background-color: #87db6b"
                data-device="Kayangan"
              ></div>
            </div>
            <div class="flex items-center justify-center">
              <div
                class="w-3 h-3 bg-red-500 rounded-full mr-1 mt-3 trash-indicator"
              ></div>
              <p class="text-xs lg:text-lg xl:text-lg text-center mt-3">
                <span class="trash-status">Penuh</span>
                <span
                  class="text-[#006134] font-semibold text-md xl:text-lg trash-percentage"
                  >100%</span
                >
              </p>
            </div>
          </div>
          <div class="flex flex-col items-center relative w-full">
            <button
              id="trackBtn"
              class="w-32 h-6 lg:w-36 lg:h-7 xl:w-40 xl:h-8 bg-[#018246] shadow-lg mx-auto mt-2 rounded-3xl flex items-center justify-center gap-1 px-2 hover:bg-green-500 text-slate-100 font-poppins text-xs lg:text-sm xl:text-base font-semibold transition-all duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-2"
            >
              <span class="flex items-center gap-1">
                Lacak Lokasi
                <img src="assets/location.png" alt="lokasi" class="h-4 w-4" />
              </span>
            </button>
            <!-- map show -->
            <div
              id="mapContainer"
              class="absolute bottom-10 hidden w-[90%] h-36 sm:h-60 md:h-64 lg:h-60 xl:h-64 rounded-xl shadow-xl border border-gray-300 overflow-hidden bg-white transition-all duration-300 ease-in-out opacity-0 z-50"
            >
              <button
                id="closeMap"
                class="absolute top-2 right-2 bg-white rounded-full shadow px-2 text-gray-700 font-bold hover:text-red-500 z-20"
              >
                ×
              </button>
              <div id="map" class="w-full h-full rounded-lg z-0"></div>
            </div>
          </div>
        </div>
        <!-- akhir tong A -->

        <div
          class="w-36 h-52 lg:w-64 lg:h-72 xl:w-72 xl:h-80 bg-white rounded-xl shadow-[4px_4px_10px_rgba(0,0,0,0.30)] transition-all duration-300 hover:scale-[1.03]"
        >
          <h4
            class="text-center text-[#006134] mt-2 font-poppins text-sm lg:text-lg xl:text-xl font-semibold"
          >
            Nirmala
          </h4>
          <div
            class="w-32 lg:w-56 xl:w-64 rounded-lg mx-auto mt-2 p-2 shadow-[4px_4px_10px_rgba(0,0,0,0.20)] transition-shadow duration-300 hover:shadow-[0_0_15px_3px_rgba(135,219,107,0.9)]"
          >
            <div class="relative trash-visual h-20 lg:h-36 xl:h-44">
              <img
                src="assets/sampahp.png"
                alt="Trash Icon"
                class="h-full w-auto mx-auto block object-contain relative z-10"
              />
              <div
                class="w-10 lg:w-16 xl:w-20 absolute bottom-0 left-0 right-0 trash-overlay rounded-b-lg mx-auto"
                style="height: 0%; background-color: #87db6b"
                data-device="Nirmala"
              ></div>
            </div>
            <div class="flex items-center justify-center">
              <div
                class="w-3 h-3 bg-red-500 rounded-full mr-1 mt-3 trash-indicator"
              ></div>
              <p class="text-xs lg:text-lg xl:text-lg text-center mt-3">
                <span class="trash-status">Penuh</span>
                <span
                  class="text-[#006134] font-semibold text-md xl:text-lg trash-percentage"
                  >100%</span
                >
              </p>
            </div>
          </div>

          <!-- Tong Sampah B (Nirmala) -->
          <div class="flex flex-col items-center relative w-full">
            <button
              id="trackBtnNirmala"
              class="w-32 h-6 lg:w-36 lg:h-7 xl:w-40 xl:h-8 bg-[#018246] shadow-lg mx-auto mt-2 rounded-3xl flex items-center justify-center gap-1 px-2 hover:bg-green-500 text-slate-100 font-poppins text-xs lg:text-sm xl:text-base font-semibold transition-all duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-2"
            >
              <span class="flex items-center gap-1">
                Lacak Lokasi
                <img src="assets/location.png" alt="lokasi" class="h-4 w-4" />
              </span>
            </button>

            <!-- Popup Map -->
            <div
              id="mapContainerNirmala"
              class="absolute bottom-10 hidden w-[90%] h-36 sm:h-60 md:h-64 lg:h-60 xl:h-64 rounded-xl shadow-xl border border-gray-300 overflow-hidden bg-white transition-all duration-300 ease-in-out opacity-0 z-50"
            >
              <button
                id="closeMapNirmala"
                class="absolute top-2 right-2 bg-white rounded-full shadow px-2 text-gray-700 font-bold hover:text-red-500 z-20"
              >
                ×
              </button>
              <div id="mapNirmala" class="w-full h-full rounded-lg z-0"></div>
            </div>
          </div>
        </div>
        <!-- akhir tong B -->

        <!-- Daftarkan -->
        <!-- <button
          onclick="openModal()"
          class="hidden lg:flex lg:mt-4 xl:mt-0 flex-col items-center justify-center text-center space-y-3 bg-[#018246] text-white font-poppins font-semibold rounded-2xl shadow-2xl w-64 h-64 xl:w-72 xl:h-80 transition-all duration-300 ease-in-out hover:bg-green-500 hover:-translate-y-1 hover:shadow-[0_0_25px_rgba(0,255,150,0.4)]"
        >
          <div
            class="text-5xl font-bold bg-white text-[#018246] w-16 h-16 xl:w-20 xl:h-20 flex items-center justify-center rounded-full shadow-md"
          >
            +
          </div>
          <span class="text-lg xl:text-xl font-semibold tracking-wide">
            Daftarkan
          </span>
        </button> -->

        <!-- <div
          id="modalDaftarkan"
          class="hidden fixed inset-0 bg-black/30 backdrop-blur-sm z-50"
        >
          <div class="fixed inset-0 flex items-center justify-center">
            <div
              class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md mx-4 transform transition-all duration-300"
              id="modalContent"
            >
              <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-semibold text-[#018246]">
                  Daftarkan Tong Sampah
                </h3>
                <button
                  id="btnCloseModal"
                  class="text-gray-500 hover:text-gray-700 transition-colors"
                >
                  <svg
                    class="w-6 h-6"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M6 18L18 6M6 6l12 12"
                    ></path>
                  </svg>
                </button>
              </div>

              <form id="formDaftarTong" class="space-y-5">
                <div>
                  <label
                    for="namaTong"
                    class="block text-sm font-medium text-gray-700 mb-2"
                    >Nama Tong Sampah</label
                  >
                  <input
                    type="text"
                    id="namaTong"
                    name="namaTong"
                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-[#018246] focus:border-[#018246] transition-colors"
                    placeholder="Masukkan nama tong sampah"
                    required
                  />
                </div>

                <div>
                  <label
                    for="kodeTong"
                    class="block text-sm font-medium text-gray-700 mb-2"
                    >Kode Tong</label
                  >
                  <input
                    type="text"
                    id="kodeTong"
                    name="kodeTong"
                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-[#018246] focus:border-[#018246] transition-colors"
                    placeholder="Masukkan kode tong"
                    required
                  />
                </div>

                <div class="flex justify-end gap-3 mt-8">
                  <button
                    type="button"
                    id="btnBatalModal"
                    class="px-6 py-2.5 border-2 border-gray-300 rounded-xl text-gray-700 hover:bg-gray-50 transition-colors font-medium"
                  >
                    Batal
                  </button>
                  <button
                    type="submit"
                    class="px-6 py-2.5 bg-[#018246] text-white rounded-xl hover:bg-green-600 transition-colors font-medium shadow-lg hover:shadow-[0_0_15px_rgba(0,255,150,0.4)]"
                  >
                    Daftarkan
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div> -->
      </div>

      <!-- <div>
        <button
          onclick="openModal()"
          class="w-36 h-10 bg-[#018246] text-white font-poppins font-semibold rounded-3xl mx-auto block shadow-xl hover:bg-green-500 hover:scale-105 transition-all duration-300 ease-in-out lg:hidden"
        >
          Daftarkan
        </button>
        <p
          class="text-xs text-center font-roboto mt-2 text-slate-900 lg:hidden xl:hidden"
        >
          Menambahkan Tong Sampah Baru
        </p>
      </div> -->
      <h1
        class="text-center text-2xl lg:text-3xl mt-5 lg:mt-10 mb-2 font-bold text-[#232323]"
      >
        Grafik Harian
      </h1>

      <!-- FILTER WAKTU & KODE TONG -->
      <!-- FILTER WAKTU & KODE TONG -->
      <div
        class="w-full max-w-md lg:max-w-3xl xl:max-w-4xl mx-auto px-3 mt-2 lg:mt-3"
      >
        <!-- FILTER BOX -->
        <div class="w-full bg-white rounded-lg p-3 shadow-sm mt-3">
          <div class="grid grid-cols-3 gap-3">
            <!-- TANGGAL -->
            <input
              type="date"
              id="filterTanggal"
              class="w-full border-b border-gray-300 focus:border-green-600 outline-none pb-1 text-gray-800 text-sm"
            />

            <!-- KODE TONG -->
            <select
              id="filterTong"
              class="w-full border-b border-gray-300 focus:border-green-600 outline-none pb-1 text-gray-800 text-sm"
            >
              <option value="">Kode Tong</option>
              <option value="Nirmala">T01 - Nirmala</option>
              <option value="Kayangan">T02 - Kayangan</option>
            </select>

            <!-- TOMBOL -->
            <button
              id="btnFilter"
              class="w-full bg-green-700 hover:bg-green-800 text-white font-semibold text-sm py-2 rounded-full shadow-md transition-all"
            >
              Tampilkan
            </button>
          </div>
        </div>

        <!-- HASIL -->
        <div class="w-full mt-3">
          <div
            id="boxHasil"
            class="bg-white rounded-xl shadow-md lg:shadow-lg min-h-[250px] lg:min-h-[320px] flex items-center justify-center text-center text-gray-600 text-sm lg:text-base px-3 py-4"
          >
            <div>
              <p class="font-semibold text-gray-800">
                Tidak ada data yang ditampilkan.
              </p>
              <p>Gunakan filter waktu dan kode tong untuk memuat data.</p>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Lokasi Semua Tong Sampah -->
    <div
      class="w-[345px] md:w-full lg:w-full xl:w-full max-w-md lg:max-w-3xl xl:max-w-4xl mx-auto px-2 lg:px-6 mt-5 mb-10"
    >
      <div
        class="bg-white rounded-lg shadow-[6px_6px_12px_rgba(0,0,0,0.15)] lg:rounded-2xl xl:rounded-3xl lg:shadow-[10px_10px_20px_rgba(0,0,0,0.2)] transition-all duration-300"
      >
        <h2
          class="font-semibold font-poppins text-[#232323] text-xl lg:text-3xl xl:text-4xl text-center mt-3 lg:mt-5 mb-"
        >
          Lokasi Tong Sampah
        </h2>

        <!-- Peta Dinamis -->
        <div
          id="mapAll"
          class="w-full h-64 lg:h-[22rem] xl:h-[26rem] rounded-b-lg shadow-lg z-0"
        ></div>

        <!-- Info jarak -->
        <p
          id="distanceInfo"
          class="text-center text-gray-700 font-medium mt-3 mb-4 text-sm lg:text-lg"
        >
          Menghitung jarak antar tong sampah...
        </p>
      </div>
    </div>

    <script>
      // === AMBIL DATA DARI API ===
      async function getTrashData() {
        try {
          const res = await fetch("https://nyampah-in.my.id/api/read.php");
          return await res.json();
        } catch (e) {
          console.error("Gagal mengambil data:", e);
          return [];
        }
      }

      // === FILTER & TAMPILKAN ===
      async function applyFilter() {
        const box = document.getElementById("boxHasil");
        const tanggal = document.getElementById("filterTanggal").value;
        const kodeTong = document.getElementById("filterTong").value;

        let data = await getTrashData();

        if (!data || data.length === 0) {
          box.innerHTML = `<p class="text-gray-600">Tidak ada data.</p>`;
          return;
        }

        // urutkan dari terbaru ke lama
        data.sort((a, b) => new Date(b.waktu) - new Date(a.waktu));

        // FILTER TANGGAL
        if (tanggal !== "") {
          data = data.filter((item) => item.waktu.startsWith(tanggal));
        }

        // FILTER DEVICE
        if (kodeTong !== "") {
          data = data.filter((item) => item.device === kodeTong);
        }

        // Jika setelah filter tidak ada data
        if (data.length === 0) {
          box.innerHTML = `
      <div>
        <p class="font-semibold text-gray-800">Data tidak ditemukan.</p>
        <p>Silakan ubah filter.</p>
      </div>`;
          return;
        }

        // Ambil hanya 2 data terbaru
        const duaData = data.slice(0, 2);

        // TAMPILKAN
        box.innerHTML = `
    <div class="w-full text-left">
      <p class="font-semibold text-gray-800 mb-3">2 Data Terbaru</p>

      <div class="space-y-3">
        ${duaData
          .map(
            (d) => `
          <div class="border rounded-lg p-3 bg-gray-50 shadow-sm">
            <p><b>Kode Tong:</b> ${d.device}</p>
            <p><b>Volume:</b> ${d.volume}%</p>
            <p><b>Lokasi:</b> ${d.latitude}, ${d.longitude}</p>
            <p><b>Waktu:</b> ${d.waktu}</p>
          </div>
        `
          )
          .join("")}
      </div>
    </div>
  `;
      }

      // === EVENT LISTENER TOMBOL ===
      document
        .getElementById("btnFilter")
        .addEventListener("click", applyFilter);

      // === AUTO UPDATE SETIAP 30 DETIK ===
      applyFilter();
      setInterval(applyFilter, 30000);
    </script>
  </body>
</html>
